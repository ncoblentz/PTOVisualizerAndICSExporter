<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Select Calendar</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #444;
        }

        /* --- Year Selector --- */
        #year-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        #year-selector label {
            font-size: 1.1em;
            font-weight: 500;
        }
        #year-input {
            font-size: 1.1em;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 80px;
            text-align: center;
        }
        #load-year-btn, #save-state-btn {
            font-size: 1.1em;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #load-year-btn:hover, #save-state-btn:hover {
            background-color: #0056b3;
        }
        #save-state-btn {
            background-color: #28a745;
        }
        #save-state-btn:hover {
            background-color: #218838;
        }

        /* --- Palette --- */
        #palette {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .palette-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
        }

        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #fff;
            transition: all 0.2s ease;
        }

        .color-swatch.selected {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            transform: scale(1.1);
        }
        
        .color-label-input {
            width: 90%;
            font-size: 0.85em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            margin-top: 8px;
        }

        .color-count {
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 8px;
            background-color: #eee;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* --- Calendar --- */
        #calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .month {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }

        .month-title {
            font-size: 1.5em;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
            color: #007bff;
        }

        .day-headers,
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
            color: #777;
            padding-bottom: 5px;
        }

        /* --- Updated Day Styles --- */
        .day {
            height: 38px;
            position: relative; 
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f4f4f4;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            /* REMOVED: overflow: hidden; -> This allows the H badge to extend out */
            transition: transform 0.1s ease-in-out;
            z-index: 1;
        }

        .day:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* The background container holds the colored stripes */
        .color-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            z-index: 0; 
            /* ADDED: Clip the stripes here instead of on the parent */
            border-radius: 5px;
            overflow: hidden;
        }

        .color-stripe {
            flex: 1; 
            height: 100%;
        }

        .day-number {
            position: relative;
            z-index: 2; 
            pointer-events: none; 
            font-weight: 500;
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }

        .day.weekend {
            background-color: #eaeaea;
            color: #666;
        }

        /* Holiday marker sits on top of everything */
        .day.holiday::after {
            content: ' H ';
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            font-size: 9px; /* Slightly larger for visibility */
            font-weight: bold;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20; /* Ensure it is above everything */
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border: 1px solid #fff; /* Small border to separate from grid */
        }

        .empty-cell {
            height: 38px;
            background-color: transparent;
        }

        /* --- Colored Dates List --- */
        #colored-dates-list {
            margin: 40px auto;
            max-width: 1800px;
            padding: 10px 20px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        #colored-dates-list h2 {
            text-align: center;
            color: #444;
            margin-bottom: 15px;
        }
        
        #dates-output {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            font-family: "Courier New", Courier, monospace;
            font-size: 0.95em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 50px;
        }
        
        .export-btn {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 0.85em;
            padding: 4px 10px;
            margin-left: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .export-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>Multi-Select Calendar</h1>
    <div id="year-selector">
        <label for="year-input">Enter Year:</label>
        <input type="number" id="year-input" value="2026" min="1900" max="2100">
        <button id="load-year-btn">Load</button>
        <button id="save-state-btn">Save</button>
    </div>

    <div id="palette">
    </div>

    <div id="calendar-container">
    </div>

    <div id="colored-dates-list">
        <h2>Colored Dates (Copy-Friendly)</h2>
        <div id="dates-output">No days colored yet.</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. STATE & CONFIGURATION ---
            
            const palette = {
                'c1': { name: 'Light Red', defaultName: 'Light Red', hex: '#ffadad', count: 0 },
                'c2': { name: 'Light Orange', defaultName: 'Light Orange', hex: '#ffd6a5', count: 0 },
                'c3': { name: 'Light Yellow', defaultName: 'Light Yellow', hex: '#fdffb6', count: 0 },
                'c4': { name: 'Light Green', defaultName: 'Light Green', hex: '#caffbf', count: 0 },
                'c5': { name: 'Light Blue', defaultName: 'Light Blue', hex: '#9bf6ff', count: 0 },
                'c6': { name: 'Indigo', defaultName: 'Indigo', hex: '#a0c4ff', count: 0 },
                'c7': { name: 'Violet', defaultName: 'Violet', hex: '#bdb2ff', count: 0 }
            };
            let selectedColorKey = 'c1';

            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const weekdayHeaders = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            const calendarContainer = document.getElementById('calendar-container');
            const paletteContainer = document.getElementById('palette');
            const datesOutput = document.getElementById('dates-output');
            const yearInput = document.getElementById('year-input');
            const loadYearBtn = document.getElementById('load-year-btn');
            const saveStateBtn = document.getElementById('save-state-btn'); 
            
            // --- 2. HOLIDAY CALCULATION LOGIC ---

            function getObservedDate(date) {
                const newDate = new Date(date.getTime());
                const dayOfWeek = newDate.getDay();
                if (dayOfWeek === 6) { // Saturday
                    newDate.setDate(newDate.getDate() - 1);
                } else if (dayOfWeek === 0) { // Sunday
                    newDate.setDate(newDate.getDate() + 1);
                }
                return newDate;
            }

            function getNthDayOfMonth(n, dayOfWeek, month, year) {
                const date = new Date(year, month, 1);
                while (date.getDay() !== dayOfWeek) {
                    date.setDate(date.getDate() + 1);
                }
                date.setDate(date.getDate() + (n - 1) * 7);
                return date;
            }

            function getLastMonday(month, year) {
                const date = new Date(year, month + 1, 0); 
                while (date.getDay() !== 1) { 
                    date.setDate(date.getDate() - 1);
                }
                return date;
            }

            function getFederalHolidays(year) {
                const holidays = new Set();
                const toISODate = (date) => date.toISOString().split('T')[0];
                
                holidays.add(toISODate(getObservedDate(new Date(year, 0, 1))));
                holidays.add(toISODate(getNthDayOfMonth(3, 1, 0, year)));
                holidays.add(toISODate(getNthDayOfMonth(3, 1, 1, year)));
                holidays.add(toISODate(getLastMonday(4, year)));
                holidays.add(toISODate(getObservedDate(new Date(year, 5, 19))));
                holidays.add(toISODate(getObservedDate(new Date(year, 6, 4))));
                holidays.add(toISODate(getNthDayOfMonth(1, 1, 8, year)));
                holidays.add(toISODate(getNthDayOfMonth(2, 1, 9, year)));
                holidays.add(toISODate(getObservedDate(new Date(year, 10, 11))));
                holidays.add(toISODate(getNthDayOfMonth(4, 4, 10, year)));
                holidays.add(toISODate(getObservedDate(new Date(year, 11, 25))));
                
                return holidays;
            }

            // --- 3. PALETTE FUNCTIONS ---

            function generatePalette() {
                paletteContainer.innerHTML = '';
                for (const key in palette) {
                    const item = palette[key];
                    
                    const paletteItem = document.createElement('div');
                    paletteItem.className = 'palette-item';

                    const swatch = document.createElement('div');
                    swatch.className = 'color-swatch';
                    swatch.id = key;
                    swatch.style.backgroundColor = item.hex;
                    swatch.dataset.colorKey = key;

                    swatch.addEventListener('click', () => {
                        const oldSelected = document.querySelector('.color-swatch.selected');
                        if (oldSelected) {
                            oldSelected.classList.remove('selected');
                        }
                        swatch.classList.add('selected');
                        selectedColorKey = swatch.dataset.colorKey;
                    });
                    
                    const labelInput = document.createElement('input');
                    labelInput.type = 'text';
                    labelInput.className = 'color-label-input';
                    labelInput.placeholder = 'Add label...';
                    labelInput.value = item.name;
                    labelInput.dataset.colorKey = key;

                    labelInput.addEventListener('input', (e) => {
                        const key = e.target.dataset.colorKey;
                        let newName = e.target.value.trim();
                        
                        if (newName === '') {
                            palette[key].name = palette[key].defaultName;
                        } else {
                            palette[key].name = newName;
                        }
                        updateColoredDatesList();
                    });
                    
                    const count = document.createElement('div');
                    count.className = 'color-count';
                    count.id = `count-${key}`;
                    count.textContent = item.count;
                    
                    paletteItem.appendChild(swatch);
                    paletteItem.appendChild(labelInput);
                    paletteItem.appendChild(count);
                    paletteContainer.appendChild(paletteItem);
                }
                document.getElementById(selectedColorKey).classList.add('selected');
            }

            function updateCounters() {
                for (const key in palette) {
                    palette[key].count = 0;
                }
                const allDays = document.querySelectorAll('.day');
                allDays.forEach(day => {
                    const activeColors = JSON.parse(day.dataset.activeColors || '[]');
                    activeColors.forEach(colorKey => {
                        if (palette[colorKey]) {
                            palette[colorKey].count++;
                        }
                    });
                });
                for (const key in palette) {
                    document.getElementById(`count-${key}`).textContent = palette[key].count;
                }
            }
            
            function resetPaletteCounts() {
                 for (const key in palette) {
                    palette[key].count = 0;
                 }
                 updateCounters();
            }

            // --- 4. CALENDAR GENERATION ---

            function generateCalendar(year) {
                const holidaySet = getFederalHolidays(year);

                for (let month = 0; month < 12; month++) {
                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'month';

                    const title = document.createElement('div');
                    title.className = 'month-title';
                    title.textContent = `${monthNames[month]} ${year}`;
                    monthDiv.appendChild(title);

                    const headersDiv = document.createElement('div');
                    headersDiv.className = 'day-headers';
                    weekdayHeaders.forEach(header => {
                        headersDiv.appendChild(document.createElement('div')).className = 'day-header';
                        headersDiv.lastChild.textContent = header;
                    });
                    monthDiv.appendChild(headersDiv);

                    const daysGrid = document.createElement('div');
                    daysGrid.className = 'days-grid';

                    const firstDay = new Date(year, month, 1);
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    const firstDayOfWeek = firstDay.getDay(); 

                    const paddingDays = firstDayOfWeek;
                    
                    for (let i = 0; i < paddingDays; i++) {
                        daysGrid.appendChild(document.createElement('div')).className = 'empty-cell';
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dayOfWeek = date.getDay();

                        const dayCell = document.createElement('div');
                        dayCell.className = 'day';
                        dayCell.dataset.activeColors = '[]'; 

                        const dateString = date.toISOString().split('T')[0];
                        dayCell.dataset.date = dateString;

                        const bgDiv = document.createElement('div');
                        bgDiv.className = 'color-background';
                        dayCell.appendChild(bgDiv);

                        const numberSpan = document.createElement('span');
                        numberSpan.className = 'day-number';
                        numberSpan.textContent = day;
                        dayCell.appendChild(numberSpan);

                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            dayCell.classList.add('weekend');
                        }
                        
                        if (holidaySet.has(dateString)) {
                            dayCell.classList.add('holiday');
                        }
                        daysGrid.appendChild(dayCell);
                    }
                    monthDiv.appendChild(daysGrid);
                    calendarContainer.appendChild(monthDiv);
                }
            }
            
            function runCalendarGeneration(year) {
                if (!year || year < 1900 || year > 2100) {
                    alert("Please enter a valid year between 1900 and 2100.");
                    return;
                }
                calendarContainer.innerHTML = '';
                resetPaletteCounts();
                updateColoredDatesList();
                generateCalendar(year);
            }

            // --- 5. RENDER HELPERS ---

            function renderDayVisuals(dayCell) {
                const activeColors = JSON.parse(dayCell.dataset.activeColors || '[]');
                const bgDiv = dayCell.querySelector('.color-background');
                bgDiv.innerHTML = ''; 

                activeColors.forEach(key => {
                    if (palette[key]) {
                        const stripe = document.createElement('div');
                        stripe.className = 'color-stripe';
                        stripe.style.backgroundColor = palette[key].hex;
                        bgDiv.appendChild(stripe);
                    }
                });
            }

            // --- 6. URL STATE MANAGEMENT ---
            
            function restoreLabelsFromURL(params) {
                for (const key in palette) {
                    const labelKey = 'l' + key.substring(1);
                    if (params.has(labelKey)) {
                        palette[key].name = params.get(labelKey);
                    }
                }
            }
            
            function restoreDatesFromURL(params) {
                for (const key in palette) {
                    if (params.has(key)) {
                        const dateStrings = params.get(key).split(',');
                        dateStrings.forEach(dateString => {
                            const dayCell = document.querySelector(`.day[data-date="${dateString}"]`);
                            if (dayCell) {
                                const currentColors = JSON.parse(dayCell.dataset.activeColors || '[]');
                                if (!currentColors.includes(key)) {
                                    currentColors.push(key);
                                    dayCell.dataset.activeColors = JSON.stringify(currentColors);
                                    renderDayVisuals(dayCell);
                                }
                            }
                        });
                    }
                }
            }

            function updateURLState() {
                const params = new URLSearchParams();
                params.set('year', yearInput.value);
                
                const colorMap = {};
                document.querySelectorAll('.day').forEach(day => {
                    const activeColors = JSON.parse(day.dataset.activeColors || '[]');
                    const date = day.dataset.date;
                    activeColors.forEach(key => {
                        if (!colorMap[key]) {
                            colorMap[key] = [];
                        }
                        colorMap[key].push(date);
                    });
                });

                for (const key in colorMap) {
                    colorMap[key].sort();
                    params.set(key, colorMap[key].join(','));
                }
                
                for (const key in palette) {
                    const labelKey = 'l' + key.substring(1);
                    if (palette[key].name !== palette[key].defaultName && palette[key].name.trim() !== '') {
                        params.set(labelKey, palette[key].name);
                    } else {
                        params.delete(labelKey);
                    }
                }

                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
                alert("State saved to URL.");
            }

            // --- 7. EVENT HANDLING & LIST UPDATING ---

            function handleDayClick(e) {
                const dayCell = e.target.closest('.day');
                if (!dayCell) return;

                const currentColors = JSON.parse(dayCell.dataset.activeColors || '[]');
                const colorIndex = currentColors.indexOf(selectedColorKey);

                if (colorIndex > -1) {
                    currentColors.splice(colorIndex, 1);
                } else {
                    currentColors.push(selectedColorKey);
                }

                dayCell.dataset.activeColors = JSON.stringify(currentColors);
                
                renderDayVisuals(dayCell);
                updateCounters();
                updateColoredDatesList();
            }

            function updateColoredDatesList() {
                let listContent = '';
                const formatOptions = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };

                for (const key in palette) {
                    const colorData = palette[key];
                    const matchingDays = [];
                    document.querySelectorAll('.day').forEach(day => {
                        const activeColors = JSON.parse(day.dataset.activeColors || '[]');
                        if (activeColors.includes(key)) {
                            matchingDays.push(day);
                        }
                    });

                    if (matchingDays.length > 0) {
                        listContent += `<strong>${colorData.name.toUpperCase()} (${colorData.hex})</strong>`;
                        listContent += `<button class="export-btn" data-color-key="${key}">Export (iCal)</button>\n`;
                        
                        const dates = [];
                        matchingDays.forEach(day => {
                            dates.push(new Date(day.dataset.date + 'T12:00:00'));
                        });

                        dates.sort((a, b) => a - b);
                        dates.forEach(date => {
                            listContent += `- ${date.toLocaleDateString('en-US', formatOptions)}\n`;
                        });
                        listContent += '\n';
                    }
                }
                datesOutput.innerHTML = listContent || 'No days colored yet.';
            }

            // --- 8. iCAL EXPORT FUNCTIONS ---

            function generateICal(colorKey) {
                const colorData = palette[colorKey];
                const label = colorData.name;
                
                const matchingDays = [];
                document.querySelectorAll('.day').forEach(day => {
                    const activeColors = JSON.parse(day.dataset.activeColors || '[]');
                    if (activeColors.includes(colorKey)) {
                        matchingDays.push(day);
                    }
                });

                if (matchingDays.length === 0) {
                    alert("No dates selected for this label.");
                    return;
                }

                const dates = [];
                matchingDays.forEach(day => dates.push(day.dataset.date)); 
                dates.sort();

                let icalContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//CalendarGenerator//EN',
                ];

                const dtstamp = new Date().toISOString().replace(/[-:.]/g, '') + 'Z';
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                dates.forEach(dateString => { 
                    const yyyymmdd = dateString.replace(/-/g, '');

                    // Event 1: All-Day OOO
                    const startDate = new Date(dateString + 'T12:00:00');
                    const nextDayDate = new Date(startDate);
                    nextDayDate.setDate(startDate.getDate() + 1);
                    const yyyymmdd_next = nextDayDate.toISOString().split('T')[0].replace(/-/g, '');

                    icalContent.push(
                        'BEGIN:VEVENT',
                        `UID:${yyyymmdd}-allday-${colorKey}@calendar.generator`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART;VALUE=DATE:${yyyymmdd}`,
                        `DTEND;VALUE=DATE:${yyyymmdd_next}`,
                        `SUMMARY:Out of Office - ${label}`,
                        'TRANSP:OPAQUE',
                        'X-GOOGLE-CALENDAR-EVENT-TYPE:OUT_OF_OFFICE',
                        'END:VEVENT'
                    );

                    // Event 2: Timed (8-5) OOO
                    icalContent.push(
                        'BEGIN:VEVENT',
                        `UID:${yyyymmdd}-timed-${colorKey}@calendar.generator`,
                        `DTSTAMP:${dtstamp}`,
                        `DTSTART;TZID=${timeZone}:${yyyymmdd}T080000`, 
                        `DTEND;TZID=${timeZone}:${yyyymmdd}T170000`,
                        `SUMMARY:Out of Office - ${label}`,
                        'TRANSP:OPAQUE',
                        'X-GOOGLE-CALENDAR-EVENT-TYPE:OUT_OF_OFFICE',
                        'END:VEVENT'
                    );
                });

                icalContent.push('END:VCALENDAR');
                const filename = `${label.replace(/[^a-z0-9]/gi, '_') || 'Calendar'}.ics`;
                downloadFile(filename, icalContent.join('\r\n'));
            }

            function downloadFile(filename, content) {
                const element = document.createElement('a');
                const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
                element.href = URL.createObjectURL(blob);
                element.download = filename;
                document.body.appendChild(element); 
                element.click();
                document.body.removeChild(element);
                URL.revokeObjectURL(element.href); 
            }

            // --- 9. INITIALIZATION ---
            
            function initializeApp() {
                const params = new URLSearchParams(window.location.search);
                restoreLabelsFromURL(params);
                generatePalette();
                const yearToLoad = parseInt(params.get('year'), 10) || new Date().getFullYear();
                yearInput.value = yearToLoad;
                runCalendarGeneration(yearToLoad);
                restoreDatesFromURL(params);
                updateCounters();
                updateColoredDatesList();

                loadYearBtn.addEventListener('click', () => {
                    const year = parseInt(yearInput.value, 10);
                    runCalendarGeneration(year);
                });
                yearInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const year = parseInt(yearInput.value, 10);
                        runCalendarGeneration(year);
                    }
                });
                saveStateBtn.addEventListener('click', updateURLState);
                calendarContainer.addEventListener('click', handleDayClick);
                datesOutput.addEventListener('click', (e) => {
                    if (e.target.classList.contains('export-btn')) {
                        const key = e.target.dataset.colorKey;
                        generateICal(key);
                    }
                });
            }

            initializeApp();

        });
    </script>
</body>
</html>
